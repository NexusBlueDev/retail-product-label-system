<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Product Scanner</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #f5f5f5;
            padding: 16px;
            padding-bottom: 80px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .camera-section {
            margin-bottom: 24px;
        }

        .file-input-wrapper {
            position: relative;
            width: 100%;
            height: 200px;
            border: 2px dashed #007AFF;
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            cursor: pointer;
            transition: all 0.3s;
        }

        .file-input-wrapper:hover {
            background: #e9ecef;
            border-color: #0051D5;
        }

        .file-input-wrapper.has-image {
            border-color: #34C759;
            background: #f0fff4;
        }

        #cameraInput {
            position: absolute;
            width: 100%;
            height: 100%;
            opacity: 0;
            cursor: pointer;
        }

        .camera-icon {
            font-size: 48px;
            margin-bottom: 8px;
        }

        .camera-text {
            color: #666;
            font-size: 14px;
        }

        .preview-image {
            display: none;
            max-width: 100%;
            max-height: 180px;
            border-radius: 8px;
            margin-top: 8px;
        }

        .status {
            text-align: center;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
            display: none;
        }

        .status.info { background: #E3F2FD; color: #1976D2; }
        .status.success { background: #E8F5E9; color: #388E3C; }
        .status.error { background: #FFEBEE; color: #C62828; }
        .status.show { display: block; }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 6px;
            color: #333;
            font-size: 14px;
        }

        input, textarea, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            font-family: inherit;
            transition: border-color 0.3s;
        }

        input:focus, textarea:focus, select:focus {
            outline: none;
            border-color: #007AFF;
        }

        textarea {
            min-height: 80px;
            resize: vertical;
        }

        .button-group {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 16px;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.1);
            display: flex;
            gap: 12px;
        }

        button {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            background: #0051D5;
        }

        .btn-secondary {
            background: #5856D6;
            color: white;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #4845B4;
        }

        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .spinner {
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .config-section {
            background: #FFF9E6;
            padding: 16px;
            border-radius: 8px;
            margin-bottom: 20px;
            border: 1px solid #FFE082;
        }

        .config-section h3 {
            font-size: 16px;
            margin-bottom: 12px;
            color: #F57C00;
        }

        .config-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #FFD54F;
            border-radius: 6px;
            font-size: 14px;
            font-family: monospace;
        }

        .config-note {
            font-size: 12px;
            color: #E65100;
            margin-top: 8px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 32px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            margin: 16px;
            box-shadow: 0 8px 24px rgba(0,0,0,0.2);
        }

        .modal-icon {
            font-size: 64px;
            margin-bottom: 16px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
        }

        .modal-message {
            font-size: 16px;
            color: #666;
            margin-bottom: 24px;
        }

        .modal-button {
            background: #34C759;
            color: white;
            padding: 12px 32px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }

        .modal-button:hover {
            background: #2DA84A;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üì¶ Product Scanner</h1>

        <!-- Configuration Section -->
        <div class="config-section" id="configSection">
            <h3>‚öôÔ∏è Setup Required</h3>
            <div class="form-group">
                <label>OpenAI API Key:</label>
                <input type="password" id="openaiKey" class="config-input" placeholder="sk-proj-...">
            </div>
            <p class="config-note">Get your API key from: platform.openai.com/api-keys</p>
        </div>

        <!-- Camera Section -->
        <div class="camera-section">
            <div class="file-input-wrapper" id="fileWrapper">
                <input type="file" id="cameraInput" accept="image/*" capture="environment">
                <div class="camera-icon">üì∑</div>
                <div class="camera-text">Tap to take photo or select image</div>
                <img id="previewImage" class="preview-image" alt="Preview">
            </div>
        </div>

        <!-- Status Messages -->
        <div id="status" class="status"></div>

        <!-- Loading Indicator -->
        <div id="loading" class="loading">
            <div class="spinner"></div>
            <p style="margin-top: 12px;">Processing image...</p>
        </div>

        <!-- Product Form -->
        <form id="productForm">
            <div class="form-group">
                <label>Product Name *</label>
                <input type="text" id="name" required>
            </div>

            <div class="form-group">
                <label>SKU</label>
                <input type="text" id="sku">
            </div>

            <div class="form-group">
                <label>Barcode</label>
                <input type="text" id="barcode">
            </div>

            <div class="form-group">
                <label>Brand</label>
                <input type="text" id="brand_name">
            </div>

            <div class="form-group">
                <label>Category</label>
                <input type="text" id="product_category">
            </div>

            <div class="form-group">
                <label>Retail Price</label>
                <input type="number" id="retail_price" step="0.01" min="0" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Supply Price</label>
                <input type="number" id="supply_price" step="0.01" min="0" placeholder="0.00">
            </div>

            <div class="form-group">
                <label>Size/Dimensions</label>
                <input type="text" id="size_or_dimensions">
            </div>

            <div class="form-group">
                <label>Tags</label>
                <input type="text" id="tags">
            </div>

            <div class="form-group">
                <label>Description</label>
                <textarea id="description"></textarea>
            </div>

            <div class="form-group">
                <label>Notes</label>
                <textarea id="notes"></textarea>
            </div>
        </form>
    </div>

    <!-- Fixed Bottom Buttons -->
    <div class="button-group">
        <button type="button" class="btn-primary" id="saveBtn" disabled>Save Product</button>
        <button type="button" class="btn-secondary" id="exportBtn">Export CSV</button>
    </div>

    <!-- Success Modal -->
    <div class="modal" id="successModal">
        <div class="modal-content">
            <div class="modal-icon">‚úÖ</div>
            <div class="modal-title">Product Saved!</div>
            <div class="modal-message">Ready to scan the next product</div>
            <button class="modal-button" onclick="closeModal()">Scan Next</button>
        </div>
    </div>

    <script>
        // Configuration - REPLACE THESE WITH YOUR VALUES
        const SUPABASE_URL = 'https://ayfwyvripnetwrkimxka.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_54gmrrTrRQFdHNshMr8aMw_CeH9r02k'; // Replace this!

        // DOM Elements
        const cameraInput = document.getElementById('cameraInput');
        const fileWrapper = document.getElementById('fileWrapper');
        const previewImage = document.getElementById('previewImage');
        const status = document.getElementById('status');
        const loading = document.getElementById('loading');
        const saveBtn = document.getElementById('saveBtn');
        const exportBtn = document.getElementById('exportBtn');
        const form = document.getElementById('productForm');
        const openaiKeyInput = document.getElementById('openaiKey');
        const configSection = document.getElementById('configSection');

        // Check for saved API key
        const savedKey = localStorage.getItem('openai_api_key');
        if (savedKey) {
            openaiKeyInput.value = savedKey;
            configSection.style.display = 'none';
        }

        // Save API key on change
        openaiKeyInput.addEventListener('change', () => {
            const key = openaiKeyInput.value.trim();
            if (key) {
                localStorage.setItem('openai_api_key', key);
                configSection.style.display = 'none';
                showStatus('API key saved!', 'success');
            }
        });

        let currentImageBase64 = null;
        let extractedData = null;

        // Camera input handler
        cameraInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            // Check for API key
            const apiKey = openaiKeyInput.value.trim() || localStorage.getItem('openai_api_key');
            if (!apiKey) {
                showStatus('Please enter your OpenAI API key first!', 'error');
                configSection.style.display = 'block';
                return;
            }

            showStatus('Image uploaded ‚úì', 'info');
            fileWrapper.classList.add('has-image');

            // Show preview
            const reader = new FileReader();
            reader.onload = (event) => {
                previewImage.src = event.target.result;
                previewImage.style.display = 'block';
            };
            reader.readAsDataURL(file);

            // Compress and convert to base64
            const base64 = await compressImage(file);
            currentImageBase64 = base64;
            
            showStatus('Base64 ready ‚úì', 'info');

            // Extract product data with AI
            await extractProductData(base64, apiKey);
        });

        // Compress image
        async function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const maxWidth = 800;
                        const maxHeight = 800;
                        
                        let width = img.width;
                        let height = img.height;
                        
                        if (width > height) {
                            if (width > maxWidth) {
                                height = Math.round((height * maxWidth) / width);
                                width = maxWidth;
                            }
                        } else {
                            if (height > maxHeight) {
                                width = Math.round((width * maxHeight) / height);
                                height = maxHeight;
                            }
                        }
                        
                        canvas.width = width;
                        canvas.height = height;
                        
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        
                        const compressed = canvas.toDataURL('image/jpeg', 0.7);
                        resolve(compressed);
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            });
        }

        // Extract product data using GPT-4o vision
        async function extractProductData(base64Image, apiKey) {
            loading.style.display = 'block';
            showStatus('Analyzing product with AI...', 'info');

            const prompt = `You are an experienced retail inventory specialist reviewing product tags and labels for Lightspeed POS import.
TASK: Analyze this product image to identify the item and extract key retail data fields in Lightspeed-compatible format.
CRITICAL PRICE RULES (apply first and always):
- Scan EVERY visible price (printed tags, stickers, crossed-out originals, handwritten notes, "was/now" markings).
- ALWAYS use the LOWEST clearly readable numeric price as retail_price.
- Handwritten prices are the current selling price ‚Äî prioritize them over printed/crossed-out ones.
- If "was $X now $Y", use the lower $Y.
- Only extract a price if you can clearly read the digits (ignore if blurry/unreadable).
- Note price context in "notes" (e.g., "handwritten current $29.85", "clearance .97", "sale .95").
YOUR EXPERTISE:
- You understand retail product labeling conventions
- You know common tag layouts for apparel, footwear, accessories, and gifts
- You recognize brand names, style codes, and SKU formats
- You understand UPC/barcode formats (12-13 clean digits, no spaces/hyphens)
- You can identify product categories and types
- Prices ending in .97 = DISCOUNTED/CLEARANCE, .95 = REGULAR SALE, .99/.00 = FULL RETAIL
INSTRUCTIONS:
1. First, identify WHAT type of product this is (jeans, boots, shirt, hat, toy, etc.)
2. Identify the BRAND if visible
3. Determine the CATEGORY using this format:
   - Apparel items: "Apparel - [Type]" (e.g., "Apparel - Jeans")
   - Footwear: "Footwear - [Type]"
   - Accessories: "Accessories - [Type]"
   - Gifts/Toys: "Gifts & Novelties - [Type]"
4. Extract standard retail fields:
   - Style/SKU codes (alphanumeric like "13MWZ", "MDM0003")
   - UPC barcodes (12-13 digits only)
   - Size information (e.g., "33x32", "15 x 32")
   - Product names or style names
   - Gender tags (Ladies, Men, Kids, Unisex)
5. Use retail knowledge for category if obvious
6. If a value is not clearly readable, use null
7. Do NOT invent, guess, or hallucinate any data ‚Äî only what is clearly visible
RETURN THIS EXACT LIGHTSPEED-COMPATIBLE JSON FORMAT (nothing else):
{
  "sku": "string or null - style/item code from label",
  "barcode": "string or null - UPC/EAN digits only (12-13 digits, no spaces/hyphens)",
  "name": "string - descriptive product name",
  "brand_name": "string or null - brand name",
  "product_category": "string or null - category in format 'Type - Subtype'",
  "retail_price": "number or null - LOWEST clearly visible price",
  "supply_price": null,
  "size_or_dimensions": "string or null - size/dimensions",
  "tags": "string or null - gender/target (e.g., 'Men')",
  "description": "string or null - additional visible details",
  "notes": "string or null - color, material, pricing context, etc."
}
EXAMPLES OF GOOD CATEGORY VALUES:
- "Apparel - Jeans"
- "Footwear - Boots"
- "Accessories - Hats"
- "Gifts & Novelties - Toys"
Return only valid JSON with no markdown formatting or code blocks.`;

            try {
                const response = await fetch('https://api.openai.com/v1/chat/completions', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: 'gpt-4o',
                        messages: [
                            {
                                role: 'user',
                                content: [
                                    { type: 'text', text: prompt },
                                    {
                                        type: 'image_url',
                                        image_url: { url: base64Image }
                                    }
                                ]
                            }
                        ],
                        max_tokens: 1000
                    })
                });

                const data = await response.json();
                
                if (data.error) {
                    throw new Error(data.error.message);
                }

                const content = data.choices[0].message.content;
                
                // Parse JSON response
                const jsonMatch = content.match(/\{[\s\S]*\}/);
                if (!jsonMatch) {
                    throw new Error('No JSON found in response');
                }
                
                extractedData = JSON.parse(jsonMatch[0]);
                
                // Populate form
                populateForm(extractedData);
                
                loading.style.display = 'none';
                showStatus(`‚úì Product detected: ${extractedData.name}`, 'success');
                saveBtn.disabled = false;
                
            } catch (error) {
                loading.style.display = 'none';
                showStatus(`Error: ${error.message}`, 'error');
                console.error('AI extraction error:', error);
            }
        }

        // Populate form with extracted data
        function populateForm(data) {
            document.getElementById('name').value = data.name || '';
            document.getElementById('sku').value = data.sku || '';
            document.getElementById('barcode').value = data.barcode || '';
            document.getElementById('brand_name').value = data.brand_name || '';
            document.getElementById('product_category').value = data.product_category || '';
            document.getElementById('retail_price').value = data.retail_price || 0;
            document.getElementById('supply_price').value = data.supply_price || 0;
            document.getElementById('size_or_dimensions').value = data.size_or_dimensions || '';
            document.getElementById('tags').value = data.tags || '';
            document.getElementById('description').value = data.description || '';
            document.getElementById('notes').value = data.notes || '';
        }

        // Save product to Supabase using REST API
        saveBtn.addEventListener('click', async () => {
            const formData = {
                name: document.getElementById('name').value,
                sku: document.getElementById('sku').value || null,
                barcode: document.getElementById('barcode').value || null,
                brand_name: document.getElementById('brand_name').value || null,
                product_category: document.getElementById('product_category').value || null,
                retail_price: parseFloat(document.getElementById('retail_price').value) || null,
                supply_price: parseFloat(document.getElementById('supply_price').value) || null,
                size_or_dimensions: document.getElementById('size_or_dimensions').value || null,
                tags: document.getElementById('tags').value || null,
                description: document.getElementById('description').value || null,
                notes: document.getElementById('notes').value || null
            };

            if (!formData.name) {
                showStatus('Product name is required!', 'error');
                return;
            }

            saveBtn.disabled = true;
            showStatus('Saving...', 'info');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Prefer': 'return=representation'
                    },
                    body: JSON.stringify(formData)
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.message || 'Save failed');
                }

                const data = await response.json();

                // Show success modal
                document.getElementById('successModal').classList.add('show');
                
                // Clear form and reset
                form.reset();
                previewImage.style.display = 'none';
                fileWrapper.classList.remove('has-image');
                cameraInput.value = '';
                saveBtn.disabled = true;
                extractedData = null;

            } catch (error) {
                showStatus(`Save error: ${error.message}`, 'error');
                console.error('Save error:', error);
                saveBtn.disabled = false;
            }
        });

        // Export to CSV
        exportBtn.addEventListener('click', async () => {
            showStatus('Fetching products...', 'info');

            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/products?select=*&order=created_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch products');
                }

                const data = await response.json();

                if (!data || data.length === 0) {
                    showStatus('No products to export', 'error');
                    return;
                }

                // Create CSV
                const headers = ['Item Name', 'SKU', 'Barcode', 'Brand', 'Category', 'Retail Price', 'Supply Price', 'Description', 'Size', 'Tags'];
                const rows = data.map(p => [
                    p.name || '',
                    p.sku || '',
                    p.barcode || '',
                    p.brand_name || '',
                    p.product_category || '',
                    p.retail_price || '',
                    p.supply_price || '',
                    p.description || '',
                    p.size_or_dimensions || '',
                    p.tags || ''
                ]);

                let csv = headers.join(',') + '\n';
                rows.forEach(row => {
                    csv += row.map(field => `"${field}"`).join(',') + '\n';
                });

                // Download CSV
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `lightspeed_products_${Date.now()}.csv`;
                a.click();

                showStatus(`‚úì Exported ${data.length} products`, 'success');

            } catch (error) {
                showStatus(`Export error: ${error.message}`, 'error');
                console.error('Export error:', error);
            }
        });

        // Show status message
        function showStatus(message, type) {
            status.textContent = message;
            status.className = `status ${type} show`;
            setTimeout(() => {
                status.classList.remove('show');
            }, 5000);
        }

        // Close success modal
        function closeModal() {
            document.getElementById('successModal').classList.remove('show');
        }
    </script>
</body>
</html>
